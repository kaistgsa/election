<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width" />
  <title>KAIST 대학원 총학생회 총선거 선거 복권 코드 검증기 / GSA Election Lottery Code Validator</title>
  <link rel="stylesheet" href="water-light.css" />
  <script>
    // 버퍼를 hex 문자열로 변환합니다.
    function bufferToHex(buffer) {
      return [...new Uint8Array(buffer)]
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // hex 문자열을 array로 변환합니다.
    function hexToArray(hex) {
      const arr = new Uint8Array(hex.length / 2);
      for (let i = 0; i < arr.length; i++) {
        arr[i] = parseInt(hex.substr(i * 2, 2), 16);
      }
      return arr;
    }

    // 공개 코드를 계산한 다음 페이지 본문에 표시합니다.
    async function validate() {
      try {
        // 모든 기능을 사용할 수 있는지 테스트합니다.
        const testKeyArray = new Uint8Array([157, 175, 221, 154, 34, 25, 28, 211, 250, 150, 9, 133, 26, 12, 21, 40, 11, 30, 95, 34, 122, 141, 219, 242, 184, 107, 20, 106, 40, 202, 255, 198]);
        const testDataArray = new Uint8Array([54, 237, 168, 107, 100, 63, 159, 168, 231, 21, 209, 185, 19, 67, 113, 12, 237, 139, 202, 79, 135, 42, 223, 22, 111, 10, 22, 87, 137, 187, 45, 26]);
        const testPublic = 'bf6ae3409b476db93a781e4dc51a00aa23c493c77dcfc486cc7ff00e93b6c143';
        const testPrivate = '36EDA86B643F9FA8E715D1B91343710CED8BCA4F872ADF166F0A165789BB2D1A9DAFDD9A22191CD3FA9609851A0C15280B1E5F227A8DDBF2B86B146A28CAFFC6';
        if (testPrivate !== (bufferToHex(testDataArray) + bufferToHex(testKeyArray)).toUpperCase()) {
          throw Error();
        }
        const testKey = await crypto.subtle.importKey('raw', testKeyArray, { name: 'HMAC', hash: 'SHA-256', length: 256 }, false, ['sign']);
        if (testPublic !== bufferToHex(await crypto.subtle.sign('HMAC', testKey, testDataArray)).toLowerCase()) {
          throw Error();
        }

        // 테스트 완료

        // 문자열 비밀 코드를 원래 상태로 되돌립니다.
        const input = document.querySelector('.code-private').value
          .split(' ').join('')
          .split('\n').join('')
          .split('\r').join('')
          .split('\t').join('');
        if (input.length !== 128) {
          alert('비밀 코드 생성 규칙으로는 생성될 수 없는 코드가 입력되었습니다. 반드시 128 글자여야 합니다. ' +
            'An invalid code has been entered that cannot be generated by the secret code creation rules. It must be exactly 128 characters long.');
          return;
        }
        if (!/^[0-9A-F]{128}$/.test(input)) {
          alert('비밀 코드 생성 규칙으로는 생성될 수 없는 코드가 입력되었습니다. 코드에 사용될 수 없는 문자가 포함되어 있습니다. ' +
            'An invalid code has been entered that cannot be generated by the secret code creation rules. The code contains characters that cannot be used.');
          return;
        }
        const dataText = input.substr(0, 64).toLowerCase();
        const keyText = input.substr(64).toLowerCase();

        const key = await crypto.subtle.importKey('raw', hexToArray(keyText),
          { name: 'HMAC', hash: 'SHA-256', length: 256 }, false, ['sign']);
        const data = hexToArray(dataText);

        // HMAC-SHA256을 계산하고, 텍스트로 변환합니다.
        const signature = await crypto.subtle.sign('HMAC', key, data);
        const signatureText = bufferToHex(signature);

        // HMAC을 공개 코드로 합니다.
        // 비밀 코드와 구분할 목적으로, 소문자만 사용합니다.
        const publicText = signatureText.toLowerCase();

        document.querySelector('.code-public').innerHTML = publicText;
      } catch (err) { // Internet Explorer에서 optional catch binding 미지원
        // 매우 오래된 웹 브라우저(Internet Explorer 10 등)에서는 실패할 수 있습니다.
        alert('코드를 계산하는 데 실패했습니다. 다른 웹 브라우저나 다른 기기로 시도해 보십시오. ' +
          'Failed to compute codes. Try with a different web browser or another device.');
      }
    }
  </script>
  <style>
    h1 {
      font-size: 1.25em;
    }

    h3 {
      margin-top: 1.5em;
      margin-bottom: 0.3em;
    }

    body {
      margin-left: 1em;
      margin-right: 1em;
      word-break: keep-all;
      margin-bottom: 3em;
    }

    .code-viewer {
      line-height: 1.4;
      border-radius: 0.4em;
      background-color: #ddd;
      padding: 0.3em 0.8em;
    }

    .code-public {
      font-family: monospace, monospace;
      font-weight: bold;
      word-break: break-all;
      font-size: 1em;
    }

    .code-private {
      font-family: monospace, monospace;
      width: 28em;
    }

    .validate-button {
      margin-top: 0.5em;
      margin-left: 2em;
      padding: 0.6em 2em;
      font-size: 1em;
      font-weight: bold;
      text-align: left;
    }

    .code-description {
      margin-top: 1.5em;
      line-height: 1.5;
      font-size: 1em;
    }

    ul {
      padding-left: 1em;
    }
  </style>
</head>

<body>
  <h1>
    KAIST 대학원 총학생회 총선거 선거 복권 코드 검증기<br />
    GSA Election Lottery Code Validator</h1>
  <p>
    KAIST 대학원 총학생회는 중앙선거관리위원회의 위탁을 받아 선거 복권 코드 생성기 운영 및 추첨 업무를 수행하고 있습니다.<br />
    The KAIST GSA operate the Election Lottery Code Generator at the request of the GSA Election Commission.
  </p>

  <button class="validate-button"
    onclick="typeof validate !== 'undefined' ? validate() : alert('코드 계산에 필요한 기능을 사용할 수 없습니다. 다른 웹 브라우저나 다른 기기로 시도해 보십시오. Some functions required for code calculation are not available. Try with a different web browser or another device.')">
    비밀 코드를 이용하여 공개 코드 계산하기<br />
    <small>Compute the Public Code Using the Given Secret Code</small>
  </button>
  <h3>비밀 코드 Private Code</h3>
  <input type="password" placeholder="여기에 비밀 코드 입력 Enter Private Code Here" class="code-private" />

  <h3>공개 코드 Public Code</h3>
  <div class="code-viewer">
    <span class="code-public">여기에 계산된 공개 코드가 표시됩니다. <small>Calculated Public Code Will Be Displayed Here.</small></span>
  </div>

  <div class="code-description">
    <ul>
      <li>
        검증기는 어떠한 내용도 저장하지 않습니다. 여러분의 웹 브라우저가 서버와의 통신 없이 직접 계산합니다.<br />
        The validator does not store any data. Your web browser performs the calculations without any communication with the server.
      </li>
      <li>
        이 페이지의 소스 코드를 확인해 보실 수 있습니다. 소스 코드상의 코드 생성 규칙을 이용하여 직접 계산하실 수도 있습니다.<br />
        You can view the source code of this page. You can also calculate it yourself using the code generation rules in the source code.
      </li>
    </ul>
  </div>
</body>

</html>